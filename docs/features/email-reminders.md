# Email Reminders

This document provides detailed information about the email reminder functionality in SupplyChain OneMed.

## Overview

The email reminder feature allows users to manually generate and send reminder emails to suppliers regarding their outstanding orders. This functionality helps maintain communication with suppliers and track correspondence related to orders processed within the SupplyChain OneMed application.

## Email Template System

### Core Template

The application uses a single, hardcoded Handlebars template (`src/services/emailTemplates/reminder.hbs`) to generate the email content. This template structures the reminder email, including a list or table of outstanding orders.

### Template Variables

The template is populated with the following data when generating an email:

- `supplier`: The name of the supplier being contacted.
- `orders`: An array containing details for each outstanding order included in the email. Each order object in the array includes:
  - `key`: Internal identifier.
  - `poNumber`: Purchase Order number.
  - `orderQty`: Quantity ordered.
  - `receivedQty`: Quantity received so far.
  - `outstandingQty`: Calculated outstanding quantity (`orderQty` - `receivedQty`).
  - `itemNo`: Item number.
  - `description`: Item description.

_(Note: The exact presentation depends on the structure within the `.hbs` file. Variables like `{{dueDate}}`, `{{companyName}}`, `{{contactPerson}}` mentioned in previous documentation versions are not directly passed in the current `EmailData` structure shown in `emailService.ts`)_

### Customization & Editing

- **Template Editing**: The application does **not** provide a built-in feature for users to directly edit or save custom versions of the `.hbs` template file.
- **Draft Editing**: Users can preview the generated email content. It's expected that final edits or customizations are made within the user's default email client (e.g., Outlook) after the draft is generated by the application.

## Sending Process

### Manual Email Sending

The process for sending reminders is manual and integrated into the primary wizard workflow:

1.  **Data Import/Selection**: User imports data via Excel and selects a specific supplier and weekday in the wizard.
2.  **Data Review**: The application displays outstanding orders for the selected supplier (`DataReview.tsx`).
3.  **Prepare Email**: User proceeds to the email step (`EmailButton.tsx`).
4.  **Preview (Optional)**: User can click "Forbered e-post" (Prepare Email) to open a preview modal (`EmailPreviewModal`) showing the generated email content based on the template and filtered order data.
5.  **Trigger Default Client**: Clicking "Send" in the preview modal (or a similar trigger) executes the `sendEmail` function.
6.  **`sendEmail` Function**: This function (handled via IPC in the main process) uses the operating system to open the user's **default email client** (e.g., Outlook, Apple Mail) with a pre-filled draft containing the recipient (supplier email, if available/configured), subject, and the HTML body generated from the template.
7.  **User Sends**: The user must manually review and click "Send" within their actual email client to dispatch the email.

### Automatic / Scheduled Sending

Automatic or scheduled email sending based on frequency or triggers is **not currently implemented**.

## Tracking and History

Email sending is tracked in a basic way:

- **Database Update**: When an email is successfully triggered via the application's "Send" button, the `recordEmailSent` function is called.
- **`recordEmailSent`**: This function (handled via IPC) updates the `email_sent_at` timestamp column in the `orders` table for the relevant orders included in that email batch.
- **Limitations**: There is no separate `email_history` table storing full email content, recipient, or delivery status. Tracking relies solely on the timestamp in the `orders` table.

## Email Client Integration

The application integrates **only** with the user's **system default email client** (e.g., Outlook, Apple Mail, Thunderbird) by generating a `mailto:` link or equivalent OS command.

Integration with direct SMTP server sending or third-party Email Service APIs is **not currently implemented** in the primary workflow.

## Usage Examples

### Triggering an Email Draft

```jsx
// Simplified conceptual flow within EmailButton.tsx or EmailPreviewModal
const handleSendTrigger = async (emailData) => {
  // emailData contains { supplier: string, orders: Array<...>, language: string }
  try {
    // 1. Generate the email content using EmailService
    const emailPayload = emailService.prepareEmailPayload(emailData); // Hypothetical method

    // 2. Call main process to open default mail client
    // This likely corresponds to window.electron.sendEmail(payload)
    const result = await window.electron.sendEmail(emailPayload);

    if (result.success) {
      // 3. If mail client was triggered, record the attempt
      await window.electron.recordEmailSent(
        emailData.supplier, // recipient/supplier name
        emailPayload.recipient, // actual email address if available
        emailPayload.subject,
        emailData.orders.map((o) => o.id) // Assuming order IDs are needed
      );
      toast.success("Email draft opened in your client");
    } else {
      toast.error(`Failed to open email client: ${result.error}`);
    }
  } catch (error) {
    console.error("Error triggering email:", error);
    toast.error("Could not open email client");
  }
};
```

## Best Practices

1.  **Review Drafts**: Always review the email draft generated in your default client before sending.
2.  **Verify Recipient**: Ensure the correct supplier email address is populated (manual check often needed).
3.  **Clarity**: Ensure the subject line and order details are clear.
4.  **Consistency**: Use the feature regularly for suppliers requiring reminders.
5.  **Follow-up**: Track responses manually or via your email client.

## Troubleshooting

Common issues and their solutions:

1.  **Email Client Not Opening**: Check system default email client settings. Ensure an email client is installed and configured.
2.  **Incorrect Content**: Verify the source data in the Excel file and the logic in the `reminder.hbs` template if accessible.
3.  **Missing Order Details**: Ensure the correct supplier was selected and the `DataReview` step showed the expected orders.
4.  **`email_sent_at` Not Updated**: Check application logs (`electron-log`) for errors during the `recordEmailSent` IPC call.

## Related Features

- [Order Tracking](order-tracking.md) - Provides the order data used for reminders.
