# Automatic Updates

SupplyChain OneMed includes code leveraging `electron-updater` to handle application updates. However, the current process for distributing and checking for these updates relies on **manual release publishing**, not a fully automated system connected to a provider like GitHub Releases. This document outlines the update-related code within the application and how users interact with it, assuming a release has been manually published correctly.

## How Updates Work (When Manually Published)

The update system is built using `electron-updater`. When a new version has been manually published according to the process in [Publishing Updates](../development/publishing-updates.md), the application attempts to find and install it using the following steps:

1. **Update Check**:

   - The application code attempts to check for updates at startup (with a 10-second delay).
   - The application code also attempts to check for updates every hour.
   - Users can trigger a manual update check from the application menu (`Help > Check for Updates`).
   - **Note:** These checks rely on `electron-updater` finding the update manifest (e.g., `latest.yml`) at an expected location, which is determined by how the application was built and where the manual release assets were placed.

2. **Update Detection**:

   - When an update is available, a notification is shown to the user
   - The notification includes the new version number

3. **Download Process**:

   - Updates are automatically downloaded in the background
   - Users see a progress indicator during the download
   - Download errors are reported to the user

4. **Installation**:
   - After the update is downloaded, users are prompted to install it
   - Users can choose to install immediately or defer the update
   - If installed immediately, the application will restart with the new version
   - If deferred, the update will be installed when the application exits (`autoInstallOnAppQuit` is enabled in the code)

## Update Configuration (Build Time)

The application's build configuration (`package.json` > `build` section) currently specifies `"publish": null`.

```json
// Excerpt from package.json
{
  // ... other config ...
  "build": {
    // ... other build settings ...
    "publish": null
    // ... win, mac, linux config ...
  }
}
```

This means `electron-updater` is **not** automatically configured with a specific provider (like `github`, `s3`, etc.). The update check mechanism relies on default conventions or potentially finding update files relative to the application's current installation, assuming they were placed correctly during a manual release deployment.

For the update check to succeed, the build artifacts (including the installer and the `latest.yml` manifest file generated by `electron-builder`) must be manually uploaded to a location where the installed application can find them. Refer to the [Publishing Updates](../development/publishing-updates.md) guide for details on the manual release process.

## User Permission Requirements

The permission requirements for installing updates depend on how the application was originally installed:

| Installation Method         | Admin Rights for Updates | Notes                                            |
| --------------------------- | ------------------------ | ------------------------------------------------ |
| MSI (per-user installation) | Not required             | Updates work without administrator privileges    |
| NSIS (per-machine)          | Required                 | Updates need the same privileges as installation |
| NSIS (current user only)    | Not required             | Updates work without administrator privileges    |
| Portable                    | Not required             | Portable version can update without admin rights |

## Implementation Details

The core auto-update logic is implemented in the following files:

- `src/main/auto-updater.ts`: Configures `electron-updater`, sets up event handlers, and defines check intervals.
- `src/main/main.ts`: Initializes the update system on application startup and integrates the manual check into the menu.
- `src/preload/index.ts`: Exposes update functions (`checkForUpdates`, `installUpdate`, etc.) and event listeners (`onUpdateAvailable`, `onUpdateDownloaded`, etc.) securely to the renderer process via `contextBridge`.
- `src/types/electron-updater.d.ts`: Provides TypeScript definitions for the `electron-updater` module.

### Auto-updater Implementation (`auto-updater.ts`)

The `src/main/auto-updater.ts` file configures `electron-updater` settings and event handlers:

```typescript
// Configuration
autoUpdater.autoDownload = true;
autoUpdater.autoInstallOnAppQuit = true;

// Event Handlers
autoUpdater.on("checking-for-update", () => { ... });
autoUpdater.on("update-not-available", (info: UpdateInfo) => { ... });
autoUpdater.on("update-available", (info: UpdateInfo) => { ... });
autoUpdater.on("download-progress", (progressObj: ProgressInfo) => { ... });
autoUpdater.on("update-downloaded", (info: UpdateInfo) => { ... });
autoUpdater.on("error", (error: Error) => { ... });
```

## Manual Update Check

Users can manually trigger an update check:

1.  **From the Help Menu**: Click `Help > Check for Updates`.

This action calls the `checkForUpdatesManually()` function in `src/main/auto-updater.ts`, which in turn calls `electron-updater`'s `checkForUpdates()` method. The success of this check depends on whether a newer version has been correctly published manually and is discoverable by the client.

## Creating and Publishing Updates

**Publishing updates is currently a manual process.** The steps involve:

1.  Updating the version in `package.json`.
2.  Building the application artifacts (installers, portable versions, `latest.yml` manifest) using `npm run dist` or via the CI workflow (`.github/workflows/build.yml`).
3.  Manually uploading these artifacts to the designated distribution point (e.g., a specific network share, server, or potentially a GitHub Release created manually).

**The `npm run release` script in `package.json` is configured with `--publish always`, but this is overridden by the `publish: null` setting in the build configuration and the CI workflow uses `--publish never`. Therefore, `npm run release` currently does NOT automatically publish artifacts to GitHub.**

Please refer to the **[Publishing Updates](../development/publishing-updates.md)** guide for the detailed, step-by-step manual release procedure.

## Troubleshooting Updates

If users encounter issues with updates:

1.  **Update Not Showing**:

    - Ensure the manual release process was completed correctly (version bumped, artifacts built, `latest.yml` and installers uploaded to the correct location).
    - Check internet connectivity if the update source is external.
    - Verify the user's installed version is lower than the published version.
    - Check application logs for errors during the `checkForUpdates` call.

2.  **Update Download Fails**:

    - Check internet connectivity.
    - Verify firewall settings if the source is external.
    - Check available disk space.
    - Review application logs (`main.log`) for specific download errors.

3.  **Update Install Fails**:

- Verify user permissions
- Check for running processes locking files
- Review application logs

Logs related to updates can be found in the application's log files:

- Windows: `%USERPROFILE%\AppData\Roaming\SupplyChainOneMed\logs\main.log`
- macOS: `~/Library/Logs/SupplyChainOneMed/main.log`

## Disabling Updates

While the application code includes update checks, these checks will only succeed if a manual release is published. Disabling primarily relates to preventing the _checks_ themselves or blocking access to the _source_ if needed in managed environments.

1.  **Development Environment**:

    - Update checks are automatically disabled when `process.env.NODE_ENV` is `"development"`.

2.  **Managed Environment**:
    - Block network access to the location where update manifests (`latest.yml`) and artifacts are manually hosted.
    - (Advanced) Modify the source code in `src/main/auto-updater.ts` to disable the checks entirely.

## Additional Resources

- [Electron Updater Documentation](https://www.electron.build/auto-update)
- [GitHub Releases Documentation](https://docs.github.com/en/repositories/releasing-projects-on-github/about-releases)
