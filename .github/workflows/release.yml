name: Release Workflow

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.3.5)"
        required: true
        type: string

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        shell: pwsh
        run: npm ci

      - name: Set version from tag or input
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")
          } else {
            $VERSION = "${{ github.event.inputs.version }}"
          }
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Setting version to: $VERSION"

      - name: Update package.json version
        shell: pwsh
        run: |
          $currentVersion = (Get-Content package.json | ConvertFrom-Json).version
          $targetVersion = "${{ steps.version.outputs.version }}"

          if ($currentVersion -ne $targetVersion) {
            npm version $targetVersion --no-git-tag-version
            Write-Host "Updated package.json from $currentVersion to $targetVersion"
          } else {
            Write-Host "Package.json already at version $targetVersion, skipping update"
          }

      - name: Build application
        shell: pwsh
        run: npm run dist:clean

      - name: Prepare Cloudflare metadata
        shell: pwsh
        run: npm run release:prepare

      - name: Create GitHub Release
        shell: pwsh
        run: npm run release:github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push Cloudflare metadata
        shell: pwsh
        continue-on-error: true
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Checkout main branch first (we're currently in detached HEAD from tag)
          git fetch origin main
          git checkout main
          git pull origin main

          # Add the metadata files
          git add docs/updates/latest.yml
          git add docs/updates/latest.json
          git add docs/updates/index.html
          git add docs/updates/_redirects

          # Check if there are any changes to commit
          if (git diff-index --quiet HEAD) {
            Write-Host "No changes in Cloudflare metadata to commit."
          } else {
            git commit -m "chore(release): Update Cloudflare metadata for v${{ steps.version.outputs.version }}"
            git push origin main
            Write-Host "Successfully pushed Cloudflare metadata updates"
          }

      - name: Verify Cloudflare deployment
        shell: pwsh
        run: |
          Write-Host "Cloudflare Pages will automatically deploy the updated metadata files"
          Write-Host "Check deployment status at: https://suppliers-anx.pages.dev/"
          Write-Host "Auto-update URL: https://suppliers-anx.pages.dev/latest.yml"

      # Note: SLACK_WEBHOOK_URL is an optional secret. If not set, this step will be skipped.
      # The linter warning about "Context access might be invalid" is expected and can be ignored.
      # Changed to always() so Slack notification is sent even if git push fails (we often push manually)
      - name: Send CHANGELOG to Slack
        if: always() && steps.version.outputs.version
        shell: bash
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
          SLACK_DISPLAY_NAME: ${{ github.actor }} (GitHub)
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ] && [ "$SLACK_WEBHOOK_URL" != "" ]; then
            echo "üìã Sending CHANGELOG to Slack..."
            node scripts/send-changelog-to-slack.js "${{ steps.version.outputs.version }}"
          else
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not set, skipping Slack notification"
          fi
